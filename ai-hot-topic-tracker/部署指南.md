# AI 热点话题追踪器 - 部署指南

## 1. 快速启动

### 1.1 前置要求

确保您的系统已安装以下软件：

- **Docker**: 版本 20.10 或更高
- **Docker Compose**: 版本 2.0 或更高
- **Git**: 用于克隆代码仓库

### 1.2 获取代码

```bash
# 克隆项目代码
git clone https://github.com/your-username/ai-hot-topic-tracker.git
cd ai-hot-topic-tracker
```

### 1.3 配置环境变量

创建环境变量文件：

```bash
# 复制环境变量模板
cp .env.example .env
```

编辑 `.env` 文件，配置必要的 API 密钥：

```env
# AI API Keys - 至少配置一个
OPENAI_API_KEY=sk-your-openai-api-key-here
DEEPSEEK_API_KEY=your-deepseek-api-key-here

# 数据源 API Keys
NEWS_API_KEY=your-newsapi-key-here

# 应用配置
DEBUG=false
APP_NAME=AI Hot Topic Tracker

# 数据库配置
DATABASE_URL=sqlite:///./data/ai_tracker.db

# CORS 配置
BACKEND_CORS_ORIGINS=["http://localhost:3000"]
```

### 1.4 启动应用

```bash
# 构建并启动所有服务
docker-compose up --build -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 1.5 访问应用

启动完成后，您可以通过以下地址访问：

- **前端界面**: http://localhost:3000
- **后端 API**: http://localhost:8000
- **API 文档**: http://localhost:8000/docs

## 2. API 密钥获取指南

### 2.1 OpenAI API 密钥

1. 访问 [OpenAI Platform](https://platform.openai.com/)
2. 注册或登录账户
3. 导航到 "API keys" 页面
4. 点击 "Create new secret key"
5. 复制生成的密钥，格式如：`sk-...`
6. 配置到环境变量 `OPENAI_API_KEY`

### 2.2 DeepSeek API 密钥

1. 访问 [DeepSeek Platform](https://platform.deepseek.com/)
2. 注册并验证账户
3. 进入 "API Keys" 管理页面
4. 创建新的 API 密钥
5. 复制密钥并配置到 `DEEPSEEK_API_KEY`

### 2.3 News API 密钥

1. 访问 [NewsAPI.org](https://newsapi.org/)
2. 点击 "Get API Key" 注册
3. 验证邮箱后获取免费 API 密钥
4. 配置到环境变量 `NEWS_API_KEY`

## 3. 本地开发环境

### 3.1 后端开发环境

```bash
cd backend

# 创建并激活虚拟环境
python -m venv venv

# Windows
venv\Scripts\activate

# macOS/Linux
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 创建环境变量文件
cp .env.example .env
# 编辑 .env 文件配置 API 密钥

# 启动开发服务器
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3.2 前端开发环境

```bash
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm start

# 应用将在 http://localhost:3000 启动
```

### 3.3 开发环境验证

1. **后端验证**:
   - 访问 http://localhost:8000
   - 访问 http://localhost:8000/docs 查看 API 文档
   - 访问 http://localhost:8000/health 检查健康状态

2. **前端验证**:
   - 访问 http://localhost:3000
   - 检查浏览器控制台是否有错误
   - 测试 WebSocket 连接状态

## 4. 生产环境部署

### 4.1 服务器要求

**最低配置**:
- CPU: 2 核心
- 内存: 4GB RAM
- 存储: 20GB 可用空间
- 操作系统: Ubuntu 20.04+ / CentOS 8+ / Docker 支持的系统

**推荐配置**:
- CPU: 4 核心
- 内存: 8GB RAM
- 存储: 50GB 可用空间
- 网络: 稳定的互联网连接

### 4.2 安装 Docker

#### Ubuntu/Debian:
```bash
# 更新包索引
sudo apt-get update

# 安装依赖
sudo apt-get install ca-certificates curl gnupg lsb-release

# 添加 Docker 官方 GPG 密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# 添加 Docker 源
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 启动 Docker 服务
sudo systemctl enable docker
sudo systemctl start docker

# 将用户添加到 docker 组
sudo usermod -aG docker $USER
```

#### CentOS/RHEL:
```bash
# 安装依赖
sudo yum install -y yum-utils

# 添加 Docker 源
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 安装 Docker
sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 启动 Docker 服务
sudo systemctl enable docker
sudo systemctl start docker

# 将用户添加到 docker 组
sudo usermod -aG docker $USER
```

### 4.3 生产环境配置

#### 创建生产环境配置文件

```bash
# 创建生产环境配置
cp docker-compose.yml docker-compose.prod.yml
```

编辑 `docker-compose.prod.yml`:

```yaml
version: '3.8'

services:
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai-tracker-backend-prod
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/ai_tracker
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - NEWS_API_KEY=${NEWS_API_KEY}
      - DEBUG=false
    volumes:
      - backend_data:/app/data
    restart: unless-stopped
    depends_on:
      - postgres
    networks:
      - ai-tracker-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ai-tracker-frontend-prod
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - ai-tracker-network

  postgres:
    image: postgres:15
    container_name: ai-tracker-postgres
    environment:
      - POSTGRES_DB=ai_tracker
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - ai-tracker-network

  redis:
    image: redis:7-alpine
    container_name: ai-tracker-redis
    restart: unless-stopped
    networks:
      - ai-tracker-network

volumes:
  backend_data:
  postgres_data:

networks:
  ai-tracker-network:
    driver: bridge
```

#### 部署到生产环境

```bash
# 创建生产环境配置文件
cp .env.example .env.prod

# 编辑生产环境配置
nano .env.prod

# 使用生产配置启动
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d --build

# 检查服务状态
docker-compose -f docker-compose.prod.yml ps
```

### 4.4 反向代理配置 (Nginx)

创建 Nginx 配置文件 `/etc/nginx/sites-available/ai-tracker`:

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名

    # 前端静态文件
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://localhost:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket 连接
    location /ws {
        proxy_pass http://localhost:8000/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

启用站点：

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/ai-tracker /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重新加载 Nginx
sudo systemctl reload nginx
```

### 4.5 SSL/HTTPS 配置

使用 Let's Encrypt 免费 SSL 证书：

```bash
# 安装 Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取 SSL 证书
sudo certbot --nginx -d your-domain.com

# 测试自动续期
sudo certbot renew --dry-run
```

## 5. 监控和维护

### 5.1 健康检查

创建健康检查脚本 `health_check.sh`:

```bash
#!/bin/bash

# 检查后端健康状态
backend_health=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)

if [ $backend_health -eq 200 ]; then
    echo "✅ 后端服务正常"
else
    echo "❌ 后端服务异常: HTTP $backend_health"
fi

# 检查前端访问
frontend_health=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)

if [ $frontend_health -eq 200 ]; then
    echo "✅ 前端服务正常"
else
    echo "❌ 前端服务异常: HTTP $frontend_health"
fi

# 检查 Docker 容器状态
echo "📊 容器状态:"
docker-compose ps
```

### 5.2 日志管理

#### 查看服务日志

```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs backend
docker-compose logs frontend

# 实时跟踪日志
docker-compose logs -f

# 查看最近 100 行日志
docker-compose logs --tail=100
```

#### 日志轮转配置

创建 `/etc/logrotate.d/ai-tracker`:

```
/var/lib/docker/containers/*/*.log {
    daily
    missingok
    rotate 7
    compress
    notifempty
    create 0644 root root
    postrotate
        /bin/kill -USR1 $(cat /var/run/docker.pid) 2>/dev/null || true
    endscript
}
```

### 5.3 备份策略

#### 数据库备份脚本

创建 `backup.sh`:

```bash
#!/bin/bash

# 设置变量
BACKUP_DIR="/backup/ai-tracker"
DATE=$(date +%Y%m%d_%H%M%S)
CONTAINER_NAME="ai-tracker-postgres"

# 创建备份目录
mkdir -p $BACKUP_DIR

# PostgreSQL 数据库备份
docker exec $CONTAINER_NAME pg_dump -U user ai_tracker > $BACKUP_DIR/db_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 删除 7 天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "✅ 数据库备份完成: db_backup_$DATE.sql.gz"
```

#### 自动备份配置

添加到 crontab:

```bash
# 编辑 crontab
crontab -e

# 添加每日备份任务（每天凌晨 2 点）
0 2 * * * /path/to/backup.sh >> /var/log/ai-tracker-backup.log 2>&1
```

### 5.4 性能监控

#### 系统资源监控

```bash
# 实时监控容器资源使用
docker stats

# 查看磁盘使用情况
df -h

# 查看内存使用情况
free -h

# 查看 CPU 使用情况
top
```

#### 应用性能监控

可以集成 Prometheus + Grafana 进行监控：

`monitoring/docker-compose.yml`:

```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped

volumes:
  grafana_data:
```

## 6. 故障排除

### 6.1 常见问题

#### 问题：容器启动失败

**排查步骤**:
1. 检查 Docker 服务状态：`sudo systemctl status docker`
2. 查看容器日志：`docker-compose logs [service_name]`
3. 检查端口占用：`netstat -tlnp | grep :8000`
4. 验证环境变量配置

#### 问题：API 密钥无效

**排查步骤**:
1. 验证 `.env` 文件中的 API 密钥格式
2. 检查 API 密钥是否过期
3. 测试 API 密钥是否有效
4. 查看后端日志中的错误信息

#### 问题：WebSocket 连接失败

**排查步骤**:
1. 检查防火墙设置
2. 验证代理配置
3. 检查 WebSocket 端点是否可访问
4. 查看浏览器控制台错误

#### 问题：数据库连接失败

**排查步骤**:
1. 检查数据库容器状态
2. 验证数据库连接字符串
3. 检查数据库用户权限
4. 查看数据库日志

### 6.2 紧急恢复

#### 快速重启服务

```bash
# 停止所有服务
docker-compose down

# 清理容器和网络
docker system prune -f

# 重新启动
docker-compose up -d --build

# 检查状态
docker-compose ps
```

#### 数据恢复

```bash
# 从备份恢复数据库
gunzip -c /backup/ai-tracker/db_backup_YYYYMMDD_HHMMSS.sql.gz | \
docker exec -i ai-tracker-postgres psql -U user -d ai_tracker
```

## 7. 更新和升级

### 7.1 应用更新

```bash
# 拉取最新代码
git pull origin main

# 重新构建和部署
docker-compose down
docker-compose up -d --build

# 检查更新后状态
docker-compose ps
docker-compose logs
```

### 7.2 数据库迁移

如果有数据库结构变更：

```bash
# 备份现有数据
./backup.sh

# 执行迁移脚本
docker exec -it ai-tracker-backend python -m alembic upgrade head
```

## 8. 安全最佳实践

### 8.1 防火墙配置

```bash
# Ubuntu UFW 配置
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 仅允许本地访问的端口
sudo ufw deny 8000
sudo ufw deny 5432
```

### 8.2 定期安全更新

```bash
# 更新系统包
sudo apt-get update && sudo apt-get upgrade -y

# 更新 Docker 镜像
docker-compose pull
docker-compose up -d --build
```

### 8.3 访问控制

在生产环境中建议：

1. 使用强密码
2. 启用 API 认证
3. 限制管理员访问
4. 定期审查访问日志
5. 使用 HTTPS 加密通信

---

本部署指南涵盖了从开发环境到生产环境的完整部署流程。如遇到问题，请参考故障排除部分或查看项目文档。
